# Learn Maintainable JavaScript

- 编写可维护的 JavaScript
    1. 软件的生命周期中 80% 的成本消耗在了维护上，而统一的编程规格易于维护；
    2. 几乎所有的软件维护者都不是它的最初作者，而统一个编程规格会使代码具有一致性；
    3. 编码规范提高了软件的可读性，它让工程师能够快速且充分的理解新的代码；
    4. 如果你将源码作为产品来发布，你需要确保它是可完整打包的，且像你创建的其他产品一样整洁；

## 1. 编程风格

编程风格 -- 编码规范的一种，用来规约单文件中代码的规划。
编程规范 -- 包含编程风格，编程最佳实践，文件和目录的规范以及注释等方面；

工具：
    一些代码检查工具，可以帮助我们规范代码，比如 JSLint 以及 JSHint（ESLint）；他们具有自己的编程规范，可以对个人代码实时追踪；如有兴趣可以了解其详细规范；

### 1.1 基本的格式化

1. 缩进层级
    如何处理缩进直接影响到了，代码是否易于阅读；目前常见的缩进风格有两种
    - 制表符缩进；
        好处:
            制表符和层级之间具有良好的对应关系，一个制表符对应这一个层级；
            一个制表符的长度是可控的；
        坏处：
            制表符在不同的编辑器下可能会被不同的方式解析，造成不能统一；
    - 空格缩进；
        常见的有 2个空格、4个空格、8个空格，建议使用 4 个空格；
        好处：
            在各种编辑器下具有统一的表现形式；
        坏处：
            没有一个配置好的编辑器创建格式化的代码方式，会导致使用起来非常繁琐；
    但是无论使用哪一种缩进方式，都必须保证统一；

2. 语句结尾

    在 JavaScript 中，语句要么是独占一行，要么以分号结尾；主要是因为分析器可以自动寻找代码（ASI）中应当使用分号但实际没有分号的位置，并插入分号，但是并不建议省略分号，因为分析器的分号插入规则非常复杂，有时会在不能插入的位置，插入分号，从而引起错误；

3. 行的长度

    建议在 JavaScript 中，限制一行的长度为 80 个字符

4. 换行

    当一行的长度达到了单行最大的字符限制的时候，需要手动换行，建议在运算符后换行，并在下一行中增加两个层级缩进；

        ```js
            var a = [1,2,3,4,5,
                    4,5,6,6]
        ```
    这个换行的要求十分重要，因为（ASI）机制，会在某些场景下，在行结束的位置插入分号，而在运算符后换行，就避免了这个问题；

    当一行结束（包括换行后的）的时候，新的语句，依然保持自己的缩进，这样更容易阅读；

        ```js
            if (a && b && c == 29 &&
                    d,e) {
                alert(1);
            }
        ```
    这里的 `alert(1)` 就保持了自己的缩进方式；

    如果在给变量赋值的时候，第二行的位置应当和赋值运算符的位置保持对齐；

        ```js
            var resule = a + b + c + d +
                         e + f;
        ```

    - 注：为了演示方便，并没有每行写入 80 个字符

5. 空行

    当一段代码的语义和另一段代码的并不相关的时候，就应该使用一个空格将两端代码隔开；从而确保将语义相关的代码展现在一起，以提高代码的可读性；

    除了使用语义进行区分，建议在遇到下列情况时进行区分也是很好的；

    - 在方法之间
    - 在方法中的局部变量和第一条语句之间
    - 在多行或单行注释之前
    - 在方法内的逻辑片段之间插入空行，提高可读性

    - 示例：

            ```js
                if (a && a.length) {
                    // 第一条语句前

                    for (i = 0, l = a.length; i <= l; i++ ) {
                        p = a[i];
                        type = b[p];
                        // 局部变量和第一条语句之间

                        if (s.hasOwnProperty(P)) {
                            // 第一条语句前

                            if (merge && type == "object") {
                                b.mix(r[p], s[p]);
                            } else {
                                alert(1);
                            }
                        }
                    }
                }
            ```

6. 命名

    在 JavaScript 语言的核心 -- ECMAScript 中，遵循着驼峰式的命名规范（由小写字母开头，以后每一个单词的首字符大写）；一般来讲，应该遵循你使用的语言的核心所采用的命名规范；

    - 变量和函数

        变量名应当总是遵循驼峰大小写的命名法，并且命名前缀最好是名词，而对于函数来说最好是动词，这个就可以通过命名来区分；

        对于变量名最好满足下列要求：
        1. 足够简练的表达其代表的含义；
        2. 尽量在变量中体现其数据类型，比如说 'num'/'length' --- 都可以一眼看出是数字
        3. 再循环中常使用 i，j，k 这些一眼就能识别的命名
        4. 避免使用没有意义的命名；

        对于函数来说，建议使用动词前缀，常用的有：
        1. 代表一种不确定性的，意味着会返回布尔值的前缀
            - can
            - has
            - is
        2. 明显含义的
            - get
            - set

    - 常量

        在 ES6 之前，JavaScript 就没有常量（一旦初始化，就不能改变的变量）的概念；为了区分，我们建议使用大写字母组成，下划线来分割单词的方式去命名常量，例如：

            ```js
                var MAX_COUNT = 10;
            ```

    - 构造函数

        JavaScript 中存在许多内置对象，例如：RegExp；我们建议使用大驼峰（上面讲到的驼峰方式又称为小驼峰方式）的方式去命名构造函数，并且最好使用名称，因为构造函数，是用来生产实例对象，和常用函数不同；

        通过不同的命名规范，可以帮助我们快速定位问题；

7. 直接量

    JavaScript 包含一些类型的原始值，比如：String、Boolean、Object、Null、Array、Undefined，在这些原值值中，只有 Boolean 的值可以自解释；其他值都需要更好的方式进行准确的表示；

    - 字符串
        在 JavaScript 中，字符串既可以使用单引号包裹，也可以使用双引号；这两种做法在功效上没有什么不同，可以根据自己的使用习惯去使用，只需要保证代码能从头到尾只保持一种风格；

        在字符串中使用多行文字：

            ```js
                var a = "this is a big pig, you \
                        have a small big"
            ```
        这种方式可以实现多行文字，但是并不是规范写法，不建议使用

            ```js
                var a = "this is a big pig, you " +
                        "have a small big"
            ```
        建议

            ```js
                var a = `this is a big pig, you
                        have a small big`
            ```
        ES6 模板字符串，建议

    - 数字
        不建议省略小数点前或者后的数字，比如：

            ```js
                var a = 10.;
                var b = .12
            ```
        不建议使用八进制的表达方式；

    - null
        null 是 Object 类型，不能将其和 undefined 搞混，可以在下列场景中使用；
        1. 初始化一个变量，这个变量可能被赋值成一个对象
        2. 用来和一个已经初始化的变量比较，这个变量可以是，也可以不是一个对象；
        3. 当函数的期望参数是一个对象，可以将 null 作为参数传入
        4. 当函数返回的期望值是一个对象，可以将 null 返回

        下面的场景中不适合使用 null
        1. 不要使用 null 来检测是否传入了某个参数，例如：

                ```js
                    function doSometing (arg1) {
                        if (arg1 != null) {
                            doSometingElse()
                        }
                    }
                ```
        2. 不要使用 null 检测一个未初始化的变量

                ```js
                    var person; // 未初始化的
                    if (person != null) {
                        alert (1)
                    }
                ```

        - 总结，对于 null 的时候，最好将其视为一个占位符

    - undefined
        undefined 常常表示这个变量等待赋值；但是建议在代码中禁止使用；因为 undefined 在代码中容易混淆，通过 typeof 检测，一个未定义的是 undefined，一个赋值为 undefined 的变量同样是 undefined，当禁止在代码中使用 undefined 后，如果我们发现一个 undefined 的时候，这个 undefined 只会是 typeof 返回的；

        如果有一个变量等待赋值，建议使用 null

    - 对象直接量
        相较于构造函数的形式创建对象，更建议使用直接量的方式创键对象；

        - 一个名值对独占一行
        - 保持一个缩进

                ```js
                    var# 1.obj = {
                        name: "ff",
                        age: "24"
                    }
                ```

    - 数组直接量
        相较于构造函数的形式创建数组，更建议使用直接量的方式创键数组；

            ```js
                var arr = [1,2,3,4]
            ```

### 1.2 注释

单行注释和多行注释

1. 单行注释
    单行注释以两个斜杠开头；

        ```js
            // 这是一段注释
        ```
    - 建议：
        - 在双斜线后添加一个空格，便于阅读
        - 独占一行的注释，用于解释下一行的代码，这行注释前总要保持一个空行，且缩进层级和下一行的代码保持一致

                ```js
                    function () {

                        // 代码执行到这里就意味着运行结束
                        alert (1);
                    }
                ```
        - 在代码行的尾部的注释，至少要与代码保持一个空格缩进，如果超出了一行的限制就将其变成独占一行的注释；

                ```js
                    function () {

                        alert(1); // 代码执行到这里就意味着运行结束
                    }
                ```
        - 被注释掉的大量代码

                ```js
                    // function () {
                        //
                       // alert(1);
                    // }
                ```
2. 多行注释
    多行注释可以包裹跨行文本；

        ```js
            /*
                这是一段注释
                这是一段注释
                这是一段注释
                这是一段注释
            */
        ```
    但是建议使用 Java 风格的注释方式：

        ```js
            /*
            * 这是一段注释
            * 这是一段注释
            * 这是一段注释
            * 这是一段注释
            */
        ```
    这样会使注释更加的清晰；

    - 需要注意：
        - 多行注释用于解释一个代码段；
        - 多行注释之间要有一个空行，和解释的代码段之间没有空行
        - 多行注释不建议使用在代码尾部；
        - 缩进层级和要描述的代码段保持一致；
        - 星号后保留一个空格便于阅读

    - 示例：

            ```js
                if (a > b) {

                    /*
                    * 我的注释
                    * 这是一段示例
                    */
                    (function () {
                        alert(1);
                    })()
                }
            ```

3. 使用注释

    使用注释的时候应该注意的原则：只有在代码不够清晰的时候才需要使用注释

    - 例如以下场景中建议添加注释：
        1. 难于理解的代码
        2. 可能被误认为错误的代码，例如：你写的代码不符合常理，可以会被认为是一段错误代码的时候；
        3. 处理浏览器特性的 hack 的时候，注释上该 hack 应对的情况

4. 文档注释
    常用的文档注释格式是 JavaDoc 格式：多行注释，比 `/**` 开头，并且使用 @ 符号来表示一个或者多个属性；

        ```js
            /**
            函数的相关解释
            @method 方法名
            @param {参数类型}
            @return {返回的类型}
            **/
        ```

    建议使用文档注释工具（例如：使用 JSDoc，具体的使用方式自行百度），生成文档，在使用文档注释的时候，应当确保对如下内容添加注释：

    1. 所有的方法：
        对方法、期望的参数和可能的返回值添加注释描述

    2. 所有的构造函数
        对自定义类型和期望的参数添加注释描述

    3. 所有包含文档化方法的对象
        如果一个对象下包含一个或者多个附带文档注释的方法，那么这个对象最好也添加文档注释

### 1.3 语句和表达式

在 JavaScript 中，如 if 和 for 之类的语句可以根据是否使用花括号分为两种写法；

```js
    if (condition) doSometing();
    if (condition) {
        doSometing()
    }
```

建议无论是否是单行，所有的块语句都应当使用花括号；

1. 花括号的对其方式
    目前存在两种对其方式：

        ```js

            // 第一种
            if (condition) {
                doSometing();
            }

            // 第二种
            if (condition)
            {
                doSometion();
            }
        ```

    - 建议使用第一种方式

2. 块语句间隔
    目前存在三种形式：

        ```js

            // 第一种，无空格
            if(condition){
                doSomething();
            };

            // 第二种，在左括号前和右括号后添加一个空格
            if (condition) {
                doSometiong();
            };

            // 第三种，在括号前后添加一个空格
            if ( condition ) {
                doSomething();
            };
        ```
    - 建议使用第二种

3. switch 语句

    1. 缩进
        建议使用格式：

            ```js
                switch (key) {
                    case value:
                        // 代码
                        break;

                    default:
                        break;
                }
            ```
        - 注：
            - 每条 case 语句相对于 switch 有一级的缩进；
            - 从第二条 case 开始，每条 case 语句前后各有一个空行；

    2. case 语句的连续执行
        建议在使用 case 语句连续执行的时候，如果并不明显需要添加注释添加注释；
        例如：

            ```js
                switch (key) {
                    case value0:
                    case value1:
                        // 代码
                        break;

                    case value2:
                        // 代码

                        /* fall through */
                    default:
                        break;
                }
            ```

    3. default
        建议如果没有默认行为，就不写 default，并添加注释

            ```js
                switch (key) {
                    case value0:
                    case value1:
                        // 代码
                        break;

                    case value2:
                        // 代码
                        break

                    // 没有默认行为
                }
            ```

4. with
    先解释一下：

        ```js
             var obj = {
                title: 'ff'
            };
            with(obj) {
                alert(title);
            };
        ```
    在 with 中的变量，会先查找 obj 的属性，在查找不到的情况下，才会在父级的执行环境中查找
    - 注：建议不要使用 with ，因为使用 with 常会对，是谁的变量产生误解

5. for 循环
    在循环中，存在两个方法：continue 和 break
    建议尽可能的减少 continue 的使用，可以使用 if 语句来实现相同的功能，但也没有必要禁止；

        ```js
            var arr = [1,2,3,4],
                len, i;
            for (i=0, len=arr.length; i < len; i++) {
                if (i != 2) {
                    doSometing(i);
                }
            }
        ```
6. for-in 循环
    for-in 循环，存在一个问题，会循环到原型链中的属性，建议使用 hasOwnProperty 的方式来避免这个问题；
    - 例如：

            ```js
                for (var key in object) {
                    if (object.hasOwnProperty(key)) {
                        // 代码
                    }
                }
            ```
    for-in 还可以循环数组，但是并不建议这样去做

### 1.4 变量、函数和运算符

1. 变量声明
    由于变量存在变量提升的现象，而这种不太明显的现象容易造成许许多多的问题，所以建议将所有的变量放在函数的顶部而不是散落在各个角落处，这样就显示的表现了变量提升，更易于开发者维护；

    - 建议：
        1. 所有的 var 合并成一个语句；(包含for循环中声明的变量)
        2. 每一个变量独占一行；
        3. 没有初始值的变量放在语句尾部；

    - 例如：

            ```js
                function doSomethingWithItem (items) {

                    var value = 10,
                        result = value + 10,
                        i,
                        len;

                    for (i=0, len=item.length; i < len; i++) {
                        doSometing(items[i]);
                    };
                }
            ```

2. 函数声明
    同样函数声明也会被 JavaScript 引擎提升；

    - 建议：
        1. 先声明函数，再使用，更利于维护；
        2. 函数内部的变量应当紧接着变量声明之后声明
        3. 函数不要在语句块中声明

    - 注：由于在 ES6 之前，JavaScript 没有块级作用域一说，所以如果在语句块中声明函数可能会导致覆盖的问题（在各个浏览器下表现可能还会存在不同），所以建议不要在语句块中声明函数

3. 函数调用间隔
    - 建议：
        1. 在函数调用的使用，函数名和左括号之间不保留空格，这样是为了更好的区分函数调用和块语句；

                ```js
                    // 好的方式
                    doSomething(item);

                    // 不好的方式
                    doSomething (item);

                    // 块语句
                    while (item) {
                        // 代码
                    }
                ```
4. 立即调用函数
    如果需要使用立即调用函数，对一个值进行赋值：

        ```js
            var value = function () {
                return 1;
            }()
        ```
    这种做法是可行的，但是会让人产生这是对变量赋值函数的行为的误解；

    - 建议：
        在立即执行函数前要有一个标示用来提示这是一个立即执行函数

            ```js
                var value = (function () {
                    return 1;
                })();
            ```

5. 严格模式
    ES5 中引入了严格模式 （"use strict"）,使用这种方式来谨慎的解析执行 JavaScript，以减少错误：
    1. 在全局的顶部使用 "use strict" 指令，将会以严格模式去解析全局代码；
    2. 在局部作用域的顶部使用 "use strict" 指令，将会以严格模式去解析局部代码；

    - 建议：
        1. 不要将 "use strict" 针对全局使用；
        2. 可以使用自执行函数在一段代码中使用 "严格模式"；
        3. 推荐尽可能使用严格模式；

    - 示例：

            ```js
               (function () {
                    "use strict";

                    function doSomething () {

                    };

                    function doSomething2 () {

                    }
               })()
            ```

6. 相等

    JavaScript 具有强制类型装换机制，对于某些运算来说，为了得到成功的结果，强制类型转换就会驱使某些类型转换成为其它类型；
    在使用 == 以及 != 来比较两个类型不同的值的时候，就会具有强制类型转换的出现：
    1. 数字和字符串比较，字符串会先转换成为数字，类似使用 Number 转换函数；
    2. 布尔值和数字比较，布尔值会转换成为数字，然后进行比较；
    3. 如果其中一个值是对象，而另一个不是，就会首先调用对象的 ValueOf() 方法，得到原始类型的值，然后比较，如果没有 ValueOf() 的方法，就会调用 toString()，然后遵循上述方式进行比较；
        例如：

                ```js
                    var obj = {
                        toString: function () {
                            return "0x19";
                        };
                    };
                    console.log(obj == 15) // true
                ```

    4. 对于 undefined == null 将会使用 toSting() 方法转换，得到 true 的结果；
    5. 相同类型的值不会发生强制类型转换；

    - 建议：
        1. 不推荐使用 == 和 != 进行比较，而应当使用 !== 和 === 两个方式进行类型比较；

7. eval()

    在 JavaScript 中，eval 会将传入的字符串当做代码去执行，类似的还有 Function 的构造函数，以及 setTimeout() 和 setInterval()
    - 原则：
        1. 禁止使用 Function，并且只有在没有别的方式的时候，才可以选择 eval；对于 setTimeout 和 setInterval 也禁止使用字符串作为执行函数；
    - 注：
        1. 在 jQ 中当涉及到回调中解析 JSON 的情况下，会使用 eval；
        2. 在 ES5 中的严格模式下，禁止在一个封闭的作用域中使用它创建新的变量或者函数；

8. 包装类型
    在 JavaScript 中存在一些基础包装类型： Number、String、Boolean；每一个类型都代表全局作用域中的一个构造函数；当我们使用一个基本类型的时候，会先根据使用的变量找到一个基本包装类型，然后创建出其实例，这个实例具有其包装类型的所有方法，当执行结束以后，就会立即销毁这个实例；所以我们可以对这个变量使用这个类型的方法，但是我们又不能对这个变量添加属性以及方法；
    - 建议：
        尽管我们可以对其包装类型添加属性和方法，但是强烈建议避免去使用包装类型，因为在对象和原始值，之间不断的跳来跳去，会让代码具有一定的迷惑性，对开发者十分的不利。